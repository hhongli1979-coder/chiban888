name: Publish Packages

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.0.9)'
        required: false
        type: string

permissions:
  contents: read
  packages: write

jobs:
  publish-npm-web:
    name: Publish NPM Package - Web
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@${{ github.repository_owner }}'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Install dependencies
        working-directory: surfsense_web
        run: pnpm install --frozen-lockfile

      - name: Build package
        working-directory: surfsense_web
        run: pnpm run build

      - name: Configure package for GitHub Packages
        working-directory: surfsense_web
        run: |
          # Update package name to include scope
          node -e "const pkg=require('./package.json'); pkg.name='@${{ github.repository_owner }}/surfsense-web'; pkg.private=false; pkg.repository={type:'git',url:'https://github.com/${{ github.repository }}.git'}; pkg.publishConfig={registry:'https://npm.pkg.github.com'}; require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2));"

      - name: Publish to GitHub Packages
        working-directory: surfsense_web
        run: pnpm publish --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-npm-extension:
    name: Publish NPM Package - Extension
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@${{ github.repository_owner }}'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Install dependencies
        working-directory: surfsense_browser_extension
        run: pnpm install --frozen-lockfile

      - name: Build package
        working-directory: surfsense_browser_extension
        run: pnpm run build

      - name: Configure package for GitHub Packages
        working-directory: surfsense_browser_extension
        run: |
          # Update package name to include scope
          node -e "const pkg=require('./package.json'); pkg.name='@${{ github.repository_owner }}/surfsense-browser-extension'; delete pkg.private; pkg.repository={type:'git',url:'https://github.com/${{ github.repository }}.git'}; pkg.publishConfig={registry:'https://npm.pkg.github.com'}; require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2));"

      - name: Publish to GitHub Packages
        working-directory: surfsense_browser_extension
        run: pnpm publish --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-python:
    name: Publish Python Package
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install UV
        uses: astral-sh/setup-uv@v3

      - name: Install build dependencies
        run: uv pip install --system build twine

      - name: Build package
        working-directory: surfsense_backend
        run: python -m build

      - name: Publish to GitHub Packages
        working-directory: surfsense_backend
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Note: GitHub Packages for Python (PyPI format) has limited availability
          # This is prepared for when it becomes available for your account type
          # For now, you may need to publish to PyPI or use alternative methods
          # Uncomment and configure based on your account capabilities:
          # twine upload --repository-url https://upload.pypi.org/legacy/ dist/*
          echo "Python package built successfully. Configure PyPI or GitHub Packages PyPI when ready."

  publish-docker:
    name: Publish Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        component: [backend, frontend]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/surfsense_${{ matrix.component }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./surfsense_${{ matrix.component == 'backend' && 'backend' || 'web' }}
          file: ./surfsense_${{ matrix.component == 'backend' && 'backend' || 'web' }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max
